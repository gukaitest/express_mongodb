<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç”¨æˆ·è¡Œä¸ºç›‘æ§å®¢æˆ·ç«¯ç¤ºä¾‹</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }
      h2 {
        color: #666;
        margin-top: 20px;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background-color: #45a049;
      }
      .log {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4caf50;
        background-color: white;
      }
      .error {
        border-left-color: #f44336;
        color: #f44336;
      }
      .info {
        border-left-color: #2196f3;
        color: #333;
      }
      .success {
        border-left-color: #4caf50;
        color: #4caf50;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin: 10px 0;
      }
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” ç”¨æˆ·è¡Œä¸ºç›‘æ§å®¢æˆ·ç«¯ç¤ºä¾‹</h1>
      <p>è¿™ä¸ªé¡µé¢æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ–°çš„ç”¨æˆ·è¡Œä¸ºç›‘æ§API</p>
    </div>

    <div class="container">
      <h2>ğŸ“Š æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º</h2>
      <button onclick="trackSessionStart()">ä¼šè¯å¼€å§‹</button>
      <button onclick="trackPageView()">é¡µé¢æµè§ˆ</button>
      <button onclick="trackClick()">ç‚¹å‡»äº‹ä»¶</button>
      <button onclick="trackScroll()">æ»šåŠ¨äº‹ä»¶</button>
      <button onclick="trackInput()">è¾“å…¥äº‹ä»¶</button>
      <button onclick="trackFocus()">ç„¦ç‚¹äº‹ä»¶</button>
      <button onclick="trackBlur()">å¤±ç„¦äº‹ä»¶</button>
      <button onclick="trackResize()">çª—å£è°ƒæ•´</button>
      <button onclick="trackCustom()">è‡ªå®šä¹‰äº‹ä»¶</button>
    </div>

    <div class="container">
      <h2>ğŸ“ˆ æŸ¥è¯¢æ•°æ®</h2>
      <button onclick="getStats()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
      <button onclick="getTopBehaviors()">è·å–çƒ­é—¨è¡Œä¸º</button>
      <button onclick="getUserPaths()">è·å–ç”¨æˆ·è·¯å¾„</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="container">
      <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
      <div id="log" class="log"></div>
    </div>

    <script>
      // é…ç½®
      const API_BASE_URL = 'http://localhost:3000/monitor/behaviors';

      // ç”Ÿæˆä¼šè¯ID
      const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const userId = localStorage.getItem('userId') || '';

      // æ—¥å¿—å‡½æ•°
      function addLog(message, type = 'info') {
        const log = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.insertBefore(entry, log.firstChild);
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
        addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
      }

      // ç”Ÿæˆ behaviorId (ç®€å•çš„base64ç¼–ç )
      function generateBehaviorId(type, action) {
        const str = `${type}_${action}_${Date.now()}`;
        return btoa(str).substring(0, 16);
      }

      // å‘é€è¡Œä¸ºæ•°æ®
      async function sendBehavior(behaviorData) {
        try {
          addLog(
            `å‘é€è¡Œä¸ºæ•°æ®: ${behaviorData.type} - ${behaviorData.action}`,
            'info'
          );

          const response = await fetch(API_BASE_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(behaviorData),
          });

          const result = await response.json();

          if (result.code === '0000') {
            addLog(`âœ… è¡Œä¸ºè®°å½•æˆåŠŸ: ${result.data._id}`, 'success');
          } else {
            addLog(`âŒ è¡Œä¸ºè®°å½•å¤±è´¥: ${result.msg}`, 'error');
          }

          return result;
        } catch (error) {
          addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
        }
      }

      // æ¨¡æ‹Ÿä¼šè¯å¼€å§‹
      async function trackSessionStart() {
        const behaviorData = {
          behaviorId: generateBehaviorId('session_start', 'session_start'),
          type: 'session_start',
          action: 'session_start',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: performance.now(),
          level: 'high',
          customData: {
            referrer: document.referrer,
            screenResolution: `${screen.width}x${screen.height}`,
            language: navigator.language,
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿé¡µé¢æµè§ˆ
      async function trackPageView() {
        const behaviorData = {
          behaviorId: generateBehaviorId('page_view', 'page_view'),
          type: 'page_view',
          action: 'page_view',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: Math.round(performance.now()),
          level: 'medium',
          customData: {
            title: document.title,
            referrer: document.referrer,
            viewportSize: `${window.innerWidth}x${window.innerHeight}`,
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
      async function trackClick() {
        const behaviorData = {
          behaviorId: generateBehaviorId('click', 'button_click'),
          type: 'click',
          action: 'button_click_test',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'medium',
          customData: {
            elementId: 'test-button',
            elementClass: 'btn btn-primary',
            elementText: 'æµ‹è¯•æŒ‰é’®',
            clickPosition: { x: 100, y: 200 },
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿæ»šåŠ¨äº‹ä»¶
      async function trackScroll() {
        const behaviorData = {
          behaviorId: generateBehaviorId('scroll', 'page_scroll'),
          type: 'scroll',
          action: 'page_scroll_down',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'low',
          customData: {
            scrollY: window.scrollY,
            scrollDepth: Math.round(
              (window.scrollY / document.body.scrollHeight) * 100
            ),
            documentHeight: document.body.scrollHeight,
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿè¾“å…¥äº‹ä»¶
      async function trackInput() {
        const behaviorData = {
          behaviorId: generateBehaviorId('input', 'form_input'),
          type: 'input',
          action: 'form_input_search',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'medium',
          customData: {
            fieldName: 'search',
            fieldType: 'text',
            inputLength: 10,
            inputValue: 'ç¤ºä¾‹æœç´¢',
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿç„¦ç‚¹äº‹ä»¶
      async function trackFocus() {
        const behaviorData = {
          behaviorId: generateBehaviorId('focus', 'element_focus'),
          type: 'focus',
          action: 'input_focus',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'low',
          customData: {
            elementId: 'search-input',
            elementType: 'input',
            fieldName: 'search',
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿå¤±ç„¦äº‹ä»¶
      async function trackBlur() {
        const behaviorData = {
          behaviorId: generateBehaviorId('blur', 'element_blur'),
          type: 'blur',
          action: 'input_blur',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'low',
          customData: {
            elementId: 'search-input',
            elementType: 'input',
            fieldName: 'search',
            inputValue: 'ç”¨æˆ·è¾“å…¥å†…å®¹',
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿçª—å£è°ƒæ•´äº‹ä»¶
      async function trackResize() {
        const behaviorData = {
          behaviorId: generateBehaviorId('resize', 'window_resize'),
          type: 'resize',
          action: 'window_resize',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'low',
          customData: {
            oldSize: {
              width: window.innerWidth - 100,
              height: window.innerHeight - 50,
            },
            newSize: {
              width: window.innerWidth,
              height: window.innerHeight,
            },
            orientation:
              window.innerWidth > window.innerHeight ? 'landscape' : 'portrait',
          },
        };

        await sendBehavior(behaviorData);
      }

      // æ¨¡æ‹Ÿè‡ªå®šä¹‰äº‹ä»¶
      async function trackCustom() {
        const behaviorData = {
          behaviorId: generateBehaviorId('custom', 'custom_action'),
          type: 'custom',
          action: 'custom_test_action',
          userId: userId,
          sessionId: sessionId,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
          pageLoadTime: 0,
          level: 'high',
          customData: {
            eventCategory: 'test',
            eventLabel: 'custom_event',
            eventValue: 123,
            additionalInfo: {
              key1: 'value1',
              key2: 'value2',
            },
          },
        };

        await sendBehavior(behaviorData);
      }

      // è·å–ç»Ÿè®¡ä¿¡æ¯
      async function getStats() {
        try {
          addLog('æ­£åœ¨è·å–ç»Ÿè®¡ä¿¡æ¯...', 'info');

          const response = await fetch(`${API_BASE_URL}/stats`);
          const result = await response.json();

          if (result.code === '0000') {
            addLog('âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ', 'success');
            addLog(JSON.stringify(result.data, null, 2), 'info');
          } else {
            addLog(`âŒ è·å–å¤±è´¥: ${result.msg}`, 'error');
          }
        } catch (error) {
          addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // è·å–çƒ­é—¨è¡Œä¸º
      async function getTopBehaviors() {
        try {
          addLog('æ­£åœ¨è·å–çƒ­é—¨è¡Œä¸º...', 'info');

          const response = await fetch(`${API_BASE_URL}/top?limit=5`);
          const result = await response.json();

          if (result.code === '0000') {
            addLog('âœ… çƒ­é—¨è¡Œä¸ºè·å–æˆåŠŸ', 'success');
            addLog(JSON.stringify(result.data, null, 2), 'info');
          } else {
            addLog(`âŒ è·å–å¤±è´¥: ${result.msg}`, 'error');
          }
        } catch (error) {
          addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // è·å–ç”¨æˆ·è·¯å¾„
      async function getUserPaths() {
        try {
          addLog('æ­£åœ¨è·å–ç”¨æˆ·è·¯å¾„...', 'info');

          const response = await fetch(
            `${API_BASE_URL}/paths?sessionId=${sessionId}&limit=10`
          );
          const result = await response.json();

          if (result.code === '0000') {
            addLog('âœ… ç”¨æˆ·è·¯å¾„è·å–æˆåŠŸ', 'success');
            addLog(JSON.stringify(result.data, null, 2), 'info');
          } else {
            addLog(`âŒ è·å–å¤±è´¥: ${result.msg}`, 'error');
          }
        } catch (error) {
          addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®°å½•ä¼šè¯å¼€å§‹
      window.addEventListener('load', () => {
        addLog(`ä¼šè¯ID: ${sessionId}`, 'info');
        addLog(`ç”¨æˆ·ID: ${userId || '(æœªè®¾ç½®)'}`, 'info');
        addLog('é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•...', 'success');
      });

      // ç›‘å¬é¡µé¢æ»šåŠ¨ï¼ˆé˜²æŠ–ï¼‰
      let scrollTimeout;
      window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          console.log('Scroll detected at:', window.scrollY);
        }, 500);
      });
    </script>
  </body>
</html>
